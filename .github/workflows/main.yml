name: "YouTube Audio to Drive (fixed)"

on:
  schedule:
    - cron: "0 1 * * *"  # chạy 04:00 VN hằng ngày (tương đương 21:00 UTC ngày trước)
    - cron: "0 4 * * *"  # chạy 04:00 VN hằng ngày (tương đương 21:00 UTC ngày trước)
    - cron: "0 7 * * *"  # chạy 04:00 VN hằng ngày (tương đương 21:00 UTC ngày trước)
    - cron: "0 10 * * *"  # chạy 04:00 VN hằng ngày (tương đương 21:00 UTC ngày trước)
    - cron: "0 13 * * *"   # chạy 15:00 VN hằng ngày (08:00 UTC)
    - cron: "0 16 * * *"   # chạy 15:00 VN hằng ngày (08:00 UTC)
    - cron: "0 19 * * *"   # chạy 15:00 VN hằng ngày (08:00 UTC)
    

  workflow_dispatch: {}

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 360
    permissions:
      contents: write

    env:
      MAX_PER_RUN: "40"
      SLEEP_SECONDS: "5"

      LINKS_FILE: "links.txt"
      DALAY_FILE: "dalay.txt"

      GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      GDRIVE_OAUTH_TOKEN_JSON: ${{ secrets.GDRIVE_OAUTH_TOKEN_JSON }}

    steps:
      - name: "Checkout"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "Show repo files"
        run: |
          ls -la
          echo
          echo "data/:"
          ls -la data || true
          echo
          echo "scripts/:"
          ls -la scripts || true

      - name: "Python setup"
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: "Setup Deno (JS runtime cho yt-dlp/EJS)"
        uses: denoland/setup-deno@v2
        with:
          deno-version: "v2.x"

      - name: "Show Deno + PATH"
        run: |
          deno --version
          which deno
          echo "PATH=$PATH"

      - name: "Show Python & pip"
        run: |
          python --version
          pip --version

      - name: "Install ffmpeg"
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg

      - name: "Check ffmpeg & disk"
        run: |
          ffmpeg -version | head -n 5
          df -h
          du -sh .

      - name: "Install yt-dlp (default deps) + update master"
        run: |
          python -m pip install --upgrade "yt-dlp[default]"
          python -m pip install --upgrade "yt-dlp @ https://github.com/yt-dlp/yt-dlp/archive/refs/heads/master.zip"
          yt-dlp --version
          python -c "import yt_dlp; print('yt-dlp OK')"
          python -c "import yt_dlp_ejs; print('yt-dlp-ejs OK')"

      - name: "Install Python deps"
        run: |
          python -m pip install --upgrade google-api-python-client google-auth google-auth-httplib2 google-auth-oauthlib

      - name: "Write cookies_multi.txt (optional)"
        env:
          _COOKIES: ${{ secrets.YT_COOKIES_MULTI }}
        run: |
          set -e
          mkdir -p data
          if [ -n "${_COOKIES}" ]; then
            printf '%s' "${_COOKIES}" > data/cookies_multi.txt
            echo "cookies_multi.txt created."
          else
            echo "YT_COOKIES_MULTI not set; skipping."
          fi

      - name: Cleanup temp audio
        if: always()
        run: |
          rm -rf "$RUNNER_TEMP/audio" || true
          rm -f data/audio || true
          mkdir -p "$RUNNER_TEMP/audio"
          ln -s "$RUNNER_TEMP/audio" data/audio

      - name: "Write po_token.txt (optional)"
        env:
          _POFILE: ${{ secrets.PO_TOKEN_FILE }}
        run: |
          set -e
          mkdir -p data
          if [ -n "${_POFILE}" ]; then
            printf '%s' "${_POFILE}" > data/po_token.txt
            echo "po_token.txt created."
          else
            echo "PO_TOKEN_FILE not set; skipping."
          fi

      - name: "Run - YouTube audio to Drive (scripts/, ROOT/data)"
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f "scripts/yt_audio_to_drive.py" ]; then
            echo "::error::Không tìm thấy scripts/yt_audio_to_drive.py"
            ls -la scripts || true
            exit 2
          fi

          mkdir -p data

          rm -rf scripts/data
          ln -s "$(pwd)/data" scripts/data

          echo "[INFO] scripts/data -> $(readlink -f scripts/data)"
          ls -la scripts | sed -n '1,200p'
          ls -la data || true

          python -u scripts/yt_audio_to_drive.py

      - name: Commit updated dalay.txt (if changed)
        if: always()
        run: |
          git config --global user.name  "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git config --global --add safe.directory "$GITHUB_WORKSPACE"

          if git diff --quiet --exit-code -- data/dalay.txt; then
            echo "No changes in dalay.txt"
          else
            git add data/dalay.txt
            git commit -m "chore: update dalay.txt (YouTube audio processed)" || exit 0
            git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
            git pull --rebase origin "${{ github.ref_name }}" || true
            git push origin "HEAD:${{ github.ref_name }}"
          fi

      - name: Disk space (after)
        if: always()
        run: df -h
